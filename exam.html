<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>English Grammar Exam - Practice Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .content {
      padding: 40px;
    }

    /* Setup Page Styles */
    .setup-page {
      text-align: center;
    }

    .setup-form {
      max-width: 550px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 30px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      color: #333;
      font-size: 1.1em;
    }

    .form-group select,
    .form-group input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #4285f4;
    }

    .difficulty-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }

    .difficulty-option {
      position: relative;
    }

    .difficulty-option input[type="checkbox"] {
      display: none;
    }

    .difficulty-option label {
      display: block;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: normal;
    }

    .difficulty-option input[type="checkbox"]:checked+label {
      background: #4285f4;
      color: white;
      border-color: #4285f4;
    }

    .start-btn {
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white;
      border: none;
      padding: 20px 40px;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.3s;
      margin-top: 20px;
    }

    .start-btn:hover {
      transform: translateY(-2px);
    }

    .start-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* Exam Page Styles */
    .exam-page {
      display: none;
    }

    .exam-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 30px;
    }

    .question-counter {
      font-size: 1.2em;
      font-weight: bold;
      color: #333;
    }

    .timer {
      background: #ff6b6b;
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 1.1em;
      font-weight: bold;
    }

    .timer.warning {
      background: #ff9500;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }
    }

    .question-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      border-left: 5px solid #4285f4;
    }

    .question-text {
      font-size: 1.3em;
      margin-bottom: 25px;
      color: #333;
      line-height: 1.6;
    }

    .question-meta {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      font-size: 0.9em;
    }

    .meta-tag {
      background: #e3f2fd;
      color: #1976d2;
      padding: 5px 12px;
      border-radius: 15px;
      font-weight: 500;
    }

    .options {
      display: grid;
      gap: 15px;
    }

    .option {
      position: relative;
    }

    .option input[type="radio"] {
      display: none;
    }

    .option label {
      display: block;
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
    }

    .option input[type="radio"]:checked+label {
      border-color: #4285f4;
      background: #e3f2fd;
    }

    .option label:hover {
      border-color: #4285f4;
      background: #f8f9fa;
    }

    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
    }

    .nav-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }

    .nav-btn:hover {
      background: #5a6268;
    }

    .nav-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .submit-btn {
      background: #28a745;
    }

    .submit-btn:hover {
      background: #218838;
    }

    /* Results Page Styles */
    .results-page {
      display: none;
      text-align: center;
    }

    .score-circle {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      margin: 30px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3em;
      font-weight: bold;
      color: white;
      position: relative;
    }

    .score-excellent {
      background: linear-gradient(135deg, #28a745, #20c997);
    }

    .score-good {
      background: linear-gradient(135deg, #ffc107, #fd7e14);
    }

    .score-fair {
      background: linear-gradient(135deg, #dc3545, #e83e8c);
    }

    .results-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .result-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      border-top: 4px solid #4285f4;
    }

    .result-card h3 {
      color: #333;
      margin-bottom: 10px;
    }

    .result-card .value {
      font-size: 2em;
      font-weight: bold;
      color: #4285f4;
    }

    .restart-btn {
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
    }

    .loading {
      text-align: center;
      padding: 50px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4285f4;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4285f4, #34a853);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 10px;
      }

      .content {
        padding: 20px;
      }

      .header {
        padding: 20px;
      }

      .header h1 {
        font-size: 1.8em;
      }

      .setup-form {
        max-width: 100%;
      }

      .difficulty-options {
        grid-template-columns: 1fr;
      }

      .results-summary {
        grid-template-columns: repeat(2, 1fr);
      }

      .exam-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .question-text {
        font-size: 1.1em;
      }

      .navigation {
        flex-direction: column;
        gap: 15px;
      }

      .nav-btn {
        width: 100%;
      }
    }

    /* Keyboard shortcuts hint */
    .keyboard-hint {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      font-size: 0.9em;
      z-index: 100;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <a href="index.html" style="color: white; text-decoration: none; font-size: 1.1em;">
          ‚Üê Back to Main Site
        </a>
        <div style="text-align: center; flex: 1;">
          <h1>üéì English Grammar Exam</h1>
          <p>Test your English grammar skills with customizable practice tests</p>
        </div>
        <div style="width: 150px;"></div> <!-- Spacer for centering -->
      </div>
    </div>

    <div class="content">
      <!-- Setup Page -->
      <div id="setupPage" class="setup-page">
        <h2>Customize Your Practice Test</h2>
        <p style="margin-bottom: 30px; color: #666;">Choose your preferences for the grammar test</p>

        <form class="setup-form" id="examSetupForm">
          <div class="form-group">
            <label for="timeLimit">‚è∞ Time Limit (minutes)</label>
            <select id="timeLimit" required>
              <option value="">Select time limit...</option>
              <option value="10">10 minutes (Quick practice)</option>
              <option value="15">15 minutes (Short test)</option>
              <option value="20">20 minutes (Standard test)</option>
              <option value="30">30 minutes (Full test)</option>
              <option value="45">45 minutes (Extended test)</option>
              <option value="0">No time limit</option>
            </select>
          </div>

          <div class="form-group">
            <label for="questionCount">üìù Number of Questions</label>
            <select id="questionCount" required>
              <option value="">Select number of questions...</option>
              <option value="5">5 questions (Quick review)</option>
              <option value="10">10 questions (Short practice)</option>
              <option value="15">15 questions (Medium practice)</option>
              <option value="20">20 questions (Standard test)</option>
              <option value="30">30 questions (Long test)</option>
              <option value="40">40 questions (Full collection)</option>
            </select>
          </div>

          <div class="form-group">
            <label>üéØ Difficulty Levels</label>
            <div class="difficulty-options">
              <div class="difficulty-option">
                <input type="checkbox" id="beginner" value="beginner" checked>
                <label for="beginner">üü¢ Beginner</label>
              </div>
              <div class="difficulty-option">
                <input type="checkbox" id="intermediate" value="intermediate" checked>
                <label for="intermediate">üü° Intermediate</label>
              </div>
              <div class="difficulty-option">
                <input type="checkbox" id="advanced" value="advanced" checked>
                <label for="advanced">üî¥ Advanced</label>
              </div>
            </div>
          </div>

          <button type="submit" class="start-btn" id="startExamBtn">
            üöÄ Start Exam
          </button>
        </form>

        <div id="loadingSection" class="loading" style="display: none;">
          <div class="spinner"></div>
          <p>Loading questions from Firebase...</p>
        </div>
      </div>

      <!-- Exam Page -->
      <div id="examPage" class="exam-page">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <div class="exam-header">
          <div class="question-counter">
            Question <span id="currentQuestionNum">1</span> of <span id="totalQuestions">10</span>
          </div>
          <div class="timer" id="timer">‚è∞ 30:00</div>
        </div>

        <div class="question-card">
          <div class="question-meta">
            <span class="meta-tag" id="questionLevel">Beginner</span>
            <span class="meta-tag" id="questionTopic">Grammar</span>
            <span class="meta-tag" id="questionDifficulty">Easy</span>
          </div>

          <div class="question-text" id="questionText">
            Loading question...
          </div>

          <div class="options" id="questionOptions">
            <!-- Options will be dynamically generated -->
          </div>
        </div>

        <div class="navigation">
          <button class="nav-btn" id="prevBtn" onclick="navigateQuestion(-1)">‚Üê Previous</button>
          <button class="nav-btn" id="nextBtn" onclick="navigateQuestion(1)">Next ‚Üí</button>
          <button class="nav-btn submit-btn" id="submitBtn" onclick="submitExam()" style="display: none;">
            üèÅ Submit Exam
          </button>
        </div>
      </div>

      <!-- Results Page -->
      <div id="resultsPage" class="results-page">
        <h2>üéâ Exam Completed!</h2>

        <div class="score-circle" id="scoreCircle">
          <span id="scorePercentage">85%</span>
        </div>

        <div class="results-summary">
          <div class="result-card">
            <h3>üìä Score</h3>
            <div class="value" id="finalScore">8/10</div>
          </div>
          <div class="result-card">
            <h3>‚è±Ô∏è Time Taken</h3>
            <div class="value" id="timeTaken">15:30</div>
          </div>
          <div class="result-card">
            <h3>üéØ Accuracy</h3>
            <div class="value" id="accuracy">80%</div>
          </div>
          <div class="result-card">
            <h3>üìà Level</h3>
            <div class="value" id="averageLevel">Mixed</div>
          </div>
        </div>

        <div style="margin-top: 30px;">
          <button class="restart-btn" onclick="restartExam()">üîÑ Take Another Test</button>
          <button class="restart-btn" onclick="viewDetailedResults()" style="background: #6c757d;">
            üìã View Detailed Results
          </button>
          <button class="restart-btn" onclick="window.location.href='index.html'" style="background: #17a2b8;">
            üè† Back to Main Site
          </button>
        </div>
      </div>

      <!-- Detailed Results Modal -->
      <div id="detailedResultsModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
        <div
          style="background: white; margin: 50px auto; padding: 30px; border-radius: 15px; max-width: 800px; max-height: 80vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>üìä Detailed Results</h2>
            <button onclick="closeDetailedResults()"
              style="background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">‚úï
              Close</button>
          </div>
          <div id="detailedResultsContent">
            <!-- Content will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAPUBwXQhhd_CfiwsAtJgc_GF2IVBk01qs",
      authDomain: "cuoikhoa-8bef5.firebaseapp.com",
      projectId: "cuoikhoa-8bef5",
      storageBucket: "cuoikhoa-8bef5.firebasestorage.app",
      messagingSenderId: "658549382274",
      appId: "1:658549382274:web:edf0f890a77c704cb5289b",
      measurementId: "G-FQHWY59NP7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Exam state
    let examState = {
      questions: [],
      currentQuestion: 0,
      answers: {},
      timeLimit: 0,
      startTime: null,
      timer: null,
      settings: {}
    };

    // Setup form handler
    document.getElementById('examSetupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await startExam();
    });

    async function startExam() {
      const form = document.getElementById('examSetupForm');
      const formData = new FormData(form);

      // Get form values
      const timeLimit = parseInt(document.getElementById('timeLimit').value);
      const questionCount = parseInt(document.getElementById('questionCount').value);
      const selectedLevels = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(cb => cb.value);

      if (selectedLevels.length === 0) {
        alert('Please select at least one difficulty level!');
        return;
      }

      // Save settings
      examState.settings = {
        timeLimit,
        questionCount,
        selectedLevels
      };

      // Show loading
      document.getElementById('setupPage').style.display = 'none';
      document.getElementById('loadingSection').style.display = 'block';

      try {
        // Load questions from Firebase
        await loadQuestions(selectedLevels, questionCount);

        // Initialize exam
        initializeExam(timeLimit);

        // Show exam page
        document.getElementById('loadingSection').style.display = 'none';
        document.getElementById('examPage').style.display = 'block';

      } catch (error) {
        console.error('Error loading questions:', error);
        alert('Error loading questions. Please try again.');
        restartExam();
      }
    }

    async function loadQuestions(levels, count) {
      try {
        // Get all questions from selected levels
        const questionsRef = collection(db, "english-grammar-questions");
        const querySnapshot = await getDocs(questionsRef);

        let allQuestions = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (levels.includes(data.level)) {
            allQuestions.push({ id: doc.id, ...data });
          }
        });

        if (allQuestions.length === 0) {
          throw new Error('No questions found for selected levels');
        }

        // Shuffle and select questions
        allQuestions = shuffleArray(allQuestions);
        examState.questions = allQuestions.slice(0, Math.min(count, allQuestions.length));

        console.log(`Loaded ${examState.questions.length} questions`);

      } catch (error) {
        console.error('Error loading questions:', error);
        throw error;
      }
    }

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function initializeExam(timeLimit) {
      examState.currentQuestion = 0;
      examState.answers = {};
      examState.startTime = new Date();

      // Set up timer
      if (timeLimit > 0) {
        examState.timeLimit = timeLimit * 60; // Convert to seconds
        startTimer();
      } else {
        document.getElementById('timer').style.display = 'none';
      }

      // Update UI
      document.getElementById('totalQuestions').textContent = examState.questions.length;
      displayCurrentQuestion();

      // Show keyboard hint
      document.getElementById('keyboardHint').style.display = 'block';
    }

    function startTimer() {
      let timeLeft = examState.timeLimit;
      const timerElement = document.getElementById('timer');

      examState.timer = setInterval(() => {
        timeLeft--;

        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.textContent = `‚è∞ ${minutes}:${seconds.toString().padStart(2, '0')}`;

        // Warning when 5 minutes left
        if (timeLeft <= 300) {
          timerElement.classList.add('warning');
        }

        // Time's up
        if (timeLeft <= 0) {
          clearInterval(examState.timer);
          submitExam();
        }
      }, 1000);
    }

    function displayCurrentQuestion() {
      const question = examState.questions[examState.currentQuestion];
      if (!question) return;

      // Update progress
      const progress = ((examState.currentQuestion + 1) / examState.questions.length) * 100;
      document.getElementById('progressFill').style.width = progress + '%';

      // Update question counter
      document.getElementById('currentQuestionNum').textContent = examState.currentQuestion + 1;

      // Update question meta
      document.getElementById('questionLevel').textContent = question.level.charAt(0).toUpperCase() + question.level.slice(1);
      document.getElementById('questionTopic').textContent = question.topic;
      document.getElementById('questionDifficulty').textContent = question.difficulty.charAt(0).toUpperCase() + question.difficulty.slice(1);

      // Update question text
      document.getElementById('questionText').textContent = question.question;

      // Update options
      const optionsContainer = document.getElementById('questionOptions');
      optionsContainer.innerHTML = '';

      question.options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option';

        const optionId = `option_${examState.currentQuestion}_${index}`;
        const isChecked = examState.answers[examState.currentQuestion] === index;

        optionDiv.innerHTML = `
                    <input type="radio" id="${optionId}" name="question_${examState.currentQuestion}" 
                           value="${index}" ${isChecked ? 'checked' : ''} 
                           onchange="saveAnswer(${examState.currentQuestion}, ${index})">
                    <label for="${optionId}">${String.fromCharCode(65 + index)}. ${option}</label>
                `;

        optionsContainer.appendChild(optionDiv);
      });

      // Update navigation buttons
      document.getElementById('prevBtn').disabled = examState.currentQuestion === 0;

      const isLastQuestion = examState.currentQuestion === examState.questions.length - 1;
      document.getElementById('nextBtn').style.display = isLastQuestion ? 'none' : 'block';
      document.getElementById('submitBtn').style.display = isLastQuestion ? 'block' : 'none';
    }

    window.saveAnswer = function (questionIndex, answerIndex) {
      examState.answers[questionIndex] = answerIndex;

      // Auto-save progress to localStorage
      localStorage.setItem('examProgress', JSON.stringify({
        answers: examState.answers,
        currentQuestion: examState.currentQuestion,
        startTime: examState.startTime,
        questions: examState.questions.map(q => q.id) // Store only IDs for security
      }));
    };

    window.navigateQuestion = function (direction) {
      const newIndex = examState.currentQuestion + direction;
      if (newIndex >= 0 && newIndex < examState.questions.length) {
        examState.currentQuestion = newIndex;
        displayCurrentQuestion();
      }
    };

    window.submitExam = function () {
      // Ki·ªÉm tra ƒë√£ tr·∫£ l·ªùi h·∫øt ch∆∞a
      const totalQuestions = examState.questions.length;
      let unanswered = [];
      for (let i = 0; i < totalQuestions; i++) {
        if (examState.answers[i] === undefined) {
          unanswered.push(i + 1);
        }
      }
      if (unanswered.length > 0) {
        alert('B·∫°n ch∆∞a tr·∫£ l·ªùi h·∫øt c√°c c√¢u h·ªèi! Vui l√≤ng ho√†n th√†nh t·∫•t c·∫£ tr∆∞·ªõc khi n·ªôp b√†i.\nC√¢u ch∆∞a l√†m: ' + unanswered.join(', '));
        // Chuy·ªÉn ƒë·∫øn c√¢u h·ªèi ƒë·∫ßu ti√™n ch∆∞a l√†m
        examState.currentQuestion = unanswered[0] - 1;
        displayCurrentQuestion();
        return;
      }

      if (confirm('Are you sure you want to submit your exam?')) {
        clearInterval(examState.timer);
        calculateResults();
        showResults();
      }
    };

    function calculateResults() {
      let correctAnswers = 0;
      const totalQuestions = examState.questions.length;

      examState.questions.forEach((question, index) => {
        const userAnswer = examState.answers[index];
        if (userAnswer === question.correctAnswer) {
          correctAnswers++;
        }
      });

      const endTime = new Date();
      const timeTaken = Math.floor((endTime - examState.startTime) / 1000);
      const percentage = Math.round((correctAnswers / totalQuestions) * 100);

      examState.results = {
        correctAnswers,
        totalQuestions,
        percentage,
        timeTaken,
        accuracy: percentage
      };
    }

    function showResults() {
      const { correctAnswers, totalQuestions, percentage, timeTaken } = examState.results;

      // Hide exam page, show results
      document.getElementById('examPage').style.display = 'none';
      document.getElementById('resultsPage').style.display = 'block';

      // Update score circle
      const scoreCircle = document.getElementById('scoreCircle');
      const scorePercentage = document.getElementById('scorePercentage');
      scorePercentage.textContent = `${percentage}%`;

      // Set score circle color based on performance
      scoreCircle.className = 'score-circle';
      if (percentage >= 80) {
        scoreCircle.classList.add('score-excellent');
      } else if (percentage >= 60) {
        scoreCircle.classList.add('score-good');
      } else {
        scoreCircle.classList.add('score-fair');
      }

      // Update result cards
      document.getElementById('finalScore').textContent = `${correctAnswers}/${totalQuestions}`;

      const minutes = Math.floor(timeTaken / 60);
      const seconds = timeTaken % 60;
      document.getElementById('timeTaken').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

      document.getElementById('accuracy').textContent = `${percentage}%`;

      // Calculate average level
      const levels = examState.questions.map(q => q.level);
      const levelCounts = levels.reduce((acc, level) => {
        acc[level] = (acc[level] || 0) + 1;
        return acc;
      }, {});
      const dominantLevel = Object.keys(levelCounts).reduce((a, b) =>
        levelCounts[a] > levelCounts[b] ? a : b
      );
      document.getElementById('averageLevel').textContent =
        dominantLevel.charAt(0).toUpperCase() + dominantLevel.slice(1);
    }

    window.restartExam = function () {
      // Reset state
      examState = {
        questions: [],
        currentQuestion: 0,
        answers: {},
        timeLimit: 0,
        startTime: null,
        timer: null,
        settings: {}
      };

      // Clear timer
      if (examState.timer) {
        clearInterval(examState.timer);
      }

      // Clear saved progress
      localStorage.removeItem('examProgress');

      // Hide keyboard hint
      document.getElementById('keyboardHint').style.display = 'none';

      // Show setup page
      document.getElementById('resultsPage').style.display = 'none';
      document.getElementById('examPage').style.display = 'none';
      document.getElementById('setupPage').style.display = 'block';

      // Reset form
      document.getElementById('examSetupForm').reset();
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    };

    window.viewDetailedResults = function () {
      const modal = document.getElementById('detailedResultsModal');
      const content = document.getElementById('detailedResultsContent');

      let html = '<div style="margin-bottom: 20px;">';
      html += `<p><strong>Overall Score:</strong> ${examState.results.correctAnswers}/${examState.results.totalQuestions} (${examState.results.percentage}%)</p>`;
      html += `<p><strong>Time Taken:</strong> ${Math.floor(examState.results.timeTaken / 60)}:${(examState.results.timeTaken % 60).toString().padStart(2, '0')}</p>`;
      html += '</div>';

      html += '<div style="margin-bottom: 20px;">';
      html += '<h3>Question Breakdown:</h3>';
      html += '</div>';

      examState.questions.forEach((question, index) => {
        const userAnswer = examState.answers[index];
        const isCorrect = userAnswer === question.correctAnswer;
        const userAnswerText = userAnswer !== undefined ? question.options[userAnswer] : 'Not answered';
        const correctAnswerText = question.options[question.correctAnswer];

        html += '<div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background: ' + (isCorrect ? '#d4edda' : '#f8d7da') + ';">';
        html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">`;
        html += `<strong>Question ${index + 1}</strong>`;
        html += `<span style="color: ${isCorrect ? '#28a745' : '#dc3545'}; font-weight: bold;">`;
        html += isCorrect ? '‚úÖ Correct' : '‚ùå Incorrect';
        html += '</span>';
        html += '</div>';

        html += `<p style="margin-bottom: 10px;"><strong>Question:</strong> ${question.question}</p>`;
        html += `<p style="margin-bottom: 5px;"><strong>Your Answer:</strong> ${userAnswerText}</p>`;
        html += `<p style="margin-bottom: 5px;"><strong>Correct Answer:</strong> ${correctAnswerText}</p>`;

        if (question.explanation) {
          html += `<p style="margin-bottom: 5px; font-style: italic;"><strong>Explanation:</strong> ${question.explanation}</p>`;
        }

        html += `<div style="margin-top: 10px;">`;
        html += `<span style="background: #e3f2fd; color: #1976d2; padding: 3px 8px; border-radius: 10px; font-size: 0.8em; margin-right: 5px;">${question.level}</span>`;
        html += `<span style="background: #f3e5f5; color: #7b1fa2; padding: 3px 8px; border-radius: 10px; font-size: 0.8em; margin-right: 5px;">${question.topic}</span>`;
        html += `<span style="background: #e8f5e8; color: #2e7d32; padding: 3px 8px; border-radius: 10px; font-size: 0.8em;">${question.difficulty}</span>`;
        html += '</div>';
        html += '</div>';
      });

      content.innerHTML = html;
      modal.style.display = 'block';
    };

    window.closeDetailedResults = function () {
      document.getElementById('detailedResultsModal').style.display = 'none';
    };

    // Initialize
    console.log('üöÄ Exam system initialized');

    // Add keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (document.getElementById('examPage').style.display === 'block') {
        switch (e.key) {
          case 'ArrowLeft':
            e.preventDefault();
            if (examState.currentQuestion > 0) {
              navigateQuestion(-1);
            }
            break;
          case 'ArrowRight':
            e.preventDefault();
            if (examState.currentQuestion < examState.questions.length - 1) {
              navigateQuestion(1);
            }
            break;
          case '1':
          case '2':
          case '3':
          case '4':
            e.preventDefault();
            const optionIndex = parseInt(e.key) - 1;
            const currentQuestion = examState.questions[examState.currentQuestion];
            if (currentQuestion && optionIndex < currentQuestion.options.length) {
              saveAnswer(examState.currentQuestion, optionIndex);
              const radioButton = document.querySelector(`input[name="question_${examState.currentQuestion}"][value="${optionIndex}"]`);
              if (radioButton) {
                radioButton.checked = true;
              }
            }
            break;
          case 'Enter':
            e.preventDefault();
            if (examState.currentQuestion === examState.questions.length - 1) {
              submitExam();
            } else {
              navigateQuestion(1);
            }
            break;
        }
      }
    });
  </script>

  <!-- Keyboard shortcuts hint (only shown during exam) -->
  <div id="keyboardHint" class="keyboard-hint" style="display: none;">
    üí° Use arrow keys to navigate, 1-4 to select answers, Enter to continue
  </div>
</body>

</html>